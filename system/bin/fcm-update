#!/system/bin/sh

REMOTE_URL="https://miceworld.top/fcm-hosts-next/fcm_dual.hosts"
LOCAL_TARGET="/data/adb/fcm-hosts/hosts"
TMP_FILE="/data/adb/fcm-hosts/hosts.tmp"
TIMESTAMP=$(date +%s)

# 下载远程文件
curl -kfsSL --connect-timeout 10 --max-time 60 \
    "${REMOTE_URL}?t=${TIMESTAMP}" -o "$TMP_FILE.download"

if [ $? -ne 0 ]; then
    echo "下载失败"
    rm -f "$TMP_FILE.download"
    exit 1
fi

# Localhost 保护 (硬编码)
echo "127.0.0.1 localhost" > "$TMP_FILE"
echo "::1 localhost ip6-localhost" >> "$TMP_FILE"
echo "" >> "$TMP_FILE"
echo "# --- FCM Optimized ---" >> "$TMP_FILE"

# 追加下载的内容
cat "$TMP_FILE.download" >> "$TMP_FILE"

# 校验内容
if ! grep -q "google" "$TMP_FILE"; then
    rm -f "$TMP_FILE" "$TMP_FILE.download"
    exit 1
fi

# 权限与上下文修复
chmod 644 "$TMP_FILE"
if [ -f /system/etc/hosts ]; then
    chcon --reference /system/etc/hosts "$TMP_FILE"
fi

# 原子替换
mv -f "$TMP_FILE" "$LOCAL_TARGET"

# 清理
rm -f "$TMP_FILE.download"
